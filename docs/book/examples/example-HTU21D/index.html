<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="None">
        <meta name="author" content="Logimic">
        <link rel="canonical" href="http://logimic.com/iqrfboard/book/examples/example-HTU21D/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>IQRFBB-10</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body class="homepage">

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="../..">IQRFBB-10</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="../..">GettingStarted</a>
                            </li>
                            <li >
                                <a href="../../IQRFBB10-Datasheet/">Datasheet</a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">IQRF Network <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li >
    <a href="../../SetupIqrfNetwork/">Setup IQRF Network</a>
</li>
                                    
<li >
    <a href="../../IqrfGatewayDaemon/">IQRF Gateway Daemon</a>
</li>
                                </ul>
                            </li>
                            <li >
                                <a href="../">Examples</a>
                            </li>
                            <li >
                                <a href="../../About/">About</a>
                            </li>
                            <li >
                                <a href="https://github.com/logimic/iqrfboard">GitHub Repo</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#temperature-humidity-sensor">Temperature &amp; Humidity Sensor</a></li>
            <li><a href="#links">Links</a></li>
            <li><a href="#prerequisities">Prerequisities</a></li>
            <li><a href="#hardware-wiring">Hardware wiring</a></li>
            <li><a href="#software">Software</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="temperature-humidity-sensor">Temperature &amp; Humidity Sensor</h1>
<p>This example shows how to connect <a href="http://wiki.keyestudio.com/index.php/Ks0020_keyestudio_Hall_Magnetic_Sensor">HTU21D</a> with the board and measure temperature and humidity.</p>
<h2 id="links">Links</h2>
<ul>
<li><a href="https://www.te.com/commerce/DocumentDelivery/DDEController?Action=showdoc&amp;DocId=Data+Sheet%7FHPC199_6%7FA6%7Fpdf%7FEnglish%7FENG_DS_HPC199_6_A6.pdf%7FCAT-HSC0004">HTU21D Datasheet</a></li>
<li><a href="../../IQRFBB10-Datasheet/">IQRFBB-10 Datasheet</a></li>
</ul>
<h2 id="prerequisities">Prerequisities</h2>
<ol>
<li><strong>IQRFBB-10</strong> bonded in working IQRF network. More in <a href="https://github.com/logimic/iqrfboard/wiki">GettingStarted with IQRFBB-10</a></li>
<li><strong>IQRF Gateway Daemon</strong> running. More in <a href="https://github.com/logimic/iqrfboard/wiki/IQRF-Gateway-Daemon">IQRF Gateway Daemon</a></li>
<li><strong>Python 3.6 with WebSockets module</strong>. More in <a href="https://github.com/logimic/iqrfboard/wiki/Get-IQRF-with-your-software#python-36-websocket-example">Python 3.6 WbSockets example</a></li>
</ol>
<h2 id="hardware-wiring">Hardware wiring</h2>
<p><img alt="" src="../../files/datasheet/layout.png" /></p>
<p><em>Fig. IQRFBB10 schema</em></p>
<p><img alt="" src="HTU21D_bb.png" /></p>
<p><em>Fig. External LED wiring</em></p>
<h2 id="software">Software</h2>
<h3 id="custom-dpa-handler">Custom DPA Handler</h3>
<p>We use Custom DPA Handler <a href="CustomDpaHandler-HTU21D-i2c.c">CustomDpaHandler-HTU21D-i2c.c</a> in this repo. Copy the file into IQRF SDK folders and load to TR module as <a href="../../SetupIqrfNetwork/#load-custom-dpa-handler">described here</a>.</p>
<pre><code class="cpp">// ***********************************************************************************
//   Custom DPA Handler code example - User peripheral implementation - i2c          *
// ***********************************************************************************
// Copyright (c) Logimic, s.r.o.
//
// File:    $RCSfile: CustomDpaHandler-HTU21D-i2c.c,v $
// Version: $Revision: 1.0 $
// Date:    $Date: 2018/08/25 18:00:00 $
//
// Revision history:
//   2015/08/05  Release for DPA 3.02
//
// *********************************************************************

// Online DPA documentation http://www.iqrf.org/DpaTechGuide/

// This example implements the user peripheral reading from HTU21D
// PNUM = 0x20 and PCMD = 0 returns 2 bytes with result read from HTU21D
// Based on example DDC-SE-01-i2c.c

// Default IQRF include (modify the path according to your setup)
#include &quot;IQRF.h&quot;

// Default DPA header (modify the path according to your setup)
#include &quot;DPA.h&quot;
// Default Custom DPA Handler header (modify the path according to your setup)
#include &quot;DPAcustomHandler.h&quot;

//############################################################################################

void i2c_init();
void i2c_shutdown();
void i2c_waitForIdle();
void i2c_start();
void i2c_repStart();
void i2c_stop();
uns8 i2c_read( bit ack );
void i2c_write( uns8 i2cWriteData );

//#define I2C_ADR           0b10010110
#define I2C_ADR             0x40
#define PWR_SENSOR_TRIS     TRISC.7
#define PWR_SENSOR_IO       LATC.7

#define TRIGGER_TEMP_MEASUREMENT 0xE3
#define TRIGGER_WRITE                        0x80
#define TRIGGER_READ                         0x81

// Must be the 1st defined function in the source code in order to be placed at the correct FLASH location!
//############################################################################################
bit CustomDpaHandler()
//############################################################################################
{
  // Handler presence mark
  clrwdt();

  // Detect DPA event to handle
  switch ( GetDpaEvent() )
  {
    // -------------------------------------------------
    case DpaEvent_Interrupt:
      // Do an extra quick background interrupt work
      // ! The time spent handling this event is critical.If there is no interrupt to handle return immediately otherwise keep the code as fast as possible.
      // ! Make sure the event is the 1st case in the main switch statement at the handler routine.This ensures that the event is handled as the 1st one.
      // ! It is desirable that this event is handled with immediate return even if it is not used by the custom handler because the Interrupt event is raised on every MCU interrupt and the �empty� return handler ensures the shortest possible interrupt routine response time.
      // ! Only global variables or local ones marked by static keyword can be used to allow reentrancy.
      // ! Make sure race condition does not occur when accessing those variables at other places.
      // ! Make sure( inspect.lst file generated by C compiler ) compiler does not create any hidden temporary local variable( occurs when using division, multiplication or bit shifts ) at the event handler code.The name of such variable is usually Cnumbercnt.
      // ! Do not call any OS functions except setINDFx().
      // ! Do not use any OS variables especially for writing access.
      // ! All above rules apply also to any other function being called from the event handler code, although calling any function from Interrupt event is not recommended because of additional MCU stack usage.

DpaHandleReturnTRUE:
      return TRUE;

      // -------------------------------------------------
    case DpaEvent_Init:
      // Do a one time initialization work before main loop starts
    case DpaEvent_AfterSleep:
      // Called after woken up after sleep

      i2c_init();
      break;

      // -------------------------------------------------
    case DpaEvent_BeforeSleep:
      // Called before going to sleep

      i2c_shutdown();
      break;

      // -------------------------------------------------
    case DpaEvent_DpaRequest:
      // Called to interpret DPA request for peripherals
      // -------------------------------------------------
      // Peripheral enumeration
      if ( IsDpaEnumPeripheralsRequest() )
      {
        // We implement 1 user peripheral
        _DpaMessage.EnumPeripheralsAnswer.UserPerNr = 1;
        FlagUserPer( _DpaMessage.EnumPeripheralsAnswer.UserPer, PNUM_USER + 0 );
        _DpaMessage.EnumPeripheralsAnswer.HWPID = 0x000F;
        _DpaMessage.EnumPeripheralsAnswer.HWPIDver = 0xAbCd;

        goto DpaHandleReturnTRUE;
      }
      // -------------------------------------------------
      // Get information about peripheral
      else if ( IsDpaPeripheralInfoRequest() )
      {
        if ( _PNUM == PNUM_USER + 0 )
        {
          _DpaMessage.PeripheralInfoAnswer.PerT = PERIPHERAL_TYPE_USER_AREA;
          _DpaMessage.PeripheralInfoAnswer.PerTE = PERIPHERAL_TYPE_EXTENDED_READ;
          goto DpaHandleReturnTRUE;
        }

        break;
      }
      // -------------------------------------------------
      else
      {
        // Handle peripheral command
        if ( _PNUM == PNUM_USER + 0 )
        {
          // Check command
          switch ( _PCMD )
          {
            case 0:
              // -------------------------------------------------
              // Read temperature
              if ( _DpaDataLength != 0 )
                DpaApiReturnPeripheralError( ERROR_DATA_LEN );

              i2c_start();
              i2c_write( TRIGGER_WRITE );
              i2c_write( TRIGGER_TEMP_MEASUREMENT );
                i2c_write( TRIGGER_READ );
              i2c_stop();

                waitMS ( 500 ); // wait for measurement

              i2c_start();
              uns16 temperature  @ _DpaMessage.Response.PData;
              temperature.high8 = i2c_read( TRUE );  // store the result
              temperature.low8 = i2c_read( TRUE );
              i2c_stop();

              _DpaDataLength = sizeof( temperature );
              goto DpaHandleReturnTRUE;

            default:
              // -------------------------------------------------
              // Invalid command
              DpaApiReturnPeripheralError( ERROR_PCMD );
          }
        }
      }
  }

  return FALSE;
}

//############################################################################################

#pragma library 1   // Compile only used functions

// *********************************************************************

void writeToSSPCON2( uns8 value @ param4.high8 )
{
  writeToRAM( &amp;SSPCON2, value );
}
//----------------------------------------------------------------------

void writeOredToSSPCON2( uns8 value @ param4.high8 )
{
  writeToSSPCON2( SSPCON2 | value );
}

//----------------------------------------------------------------------

void i2c_init()
{
  PORTC = 0x80;                       // port

  TRISC.3 = 1;                        // SCL as input (SIM C6)
  TRISC.4 = 1;                        // SDA as input (SIM C7)

  PWR_SENSOR_TRIS = 0;                // sensor power as output (SIM C8)
  TRISC.5 = 1;                        // shared with SIM C8

  TRISA.5 = 1;                        // sensor ALERT as input (SIM C5)
  TRISB.4 = 1;                        // shared with SIM C5
  TRISC.6 = 1;                        // shared with SIM C5

  writeToRAM( &amp;SSPCON1, 0x38 );       // I2C master mode     SSPCON = 0b00111000
  writeToSSPCON2( 0x00 );

  SSPADD = ( F_OSC / 50000 / 4 ) - 2; // 50 kHz SCL frequency

  SMP = 1;                            // Disable slew rate control
}

//------------------------------------------------------------------------

void i2c_shutdown()
{
  writeToRAM( &amp;SSPCON1, 0x00 );       // I2C master mode     SSPCON = 0
}

//------------------------------------------------------------------------
void i2c_waitForIdle()
{
  while ( SSPCON2 &amp; 0x1F );           // Wait for idle and not writing
  while ( RW_ );                      // Wait for idle and not writing
}
//----------------------------------------------------------------------

void i2c_start()
{
  i2c_waitForIdle();
  writeOredToSSPCON2( 0x01 );       // SEN = 1
}
//----------------------------------------------------------------------

void i2c_repStart()
{
  i2c_waitForIdle();
  writeOredToSSPCON2( 0x02 );       // RSEN = 1
}
//----------------------------------------------------------------------

void i2c_stop()
{
  i2c_waitForIdle();
  writeOredToSSPCON2( 0x04 );       // PEN = 1
}
//----------------------------------------------------------------------

uns8 i2c_read( bit ack )
{
  i2c_waitForIdle();
  writeOredToSSPCON2( 0x08 );       // RCEN = 1

  i2c_waitForIdle();

  uns8 i2cReadData @ userReg0;
  i2cReadData = SSPBUF;

  i2c_waitForIdle();

  if ( ack )
    writeToSSPCON2( SSPCON2 &amp; 0xDF ); // Acknowledge, ACKDT = 0
  else
    writeOredToSSPCON2( 0x20 );       // Not acknowledge, ACKDT = 1

  writeOredToSSPCON2( 0x10 );         // Send acknowledge sequence, ACKEN = 1
  return i2cReadData;
}
//----------------------------------------------------------------------

void i2c_write( uns8 i2cWriteData @ param2 )
{
  i2c_waitForIdle();
  SSPBUF = i2cWriteData;
}

// ############################################################################################
#pragma library 0   // Compile all
//############################################################################################
// Default Custom DPA Handler header; 2nd include to implement Code bumper to detect too long code of the Custom DPA Handler (modify the path according to your setup)
#include &quot;DPAcustomHandler.h&quot;
//############################################################################################

</code></pre>

<ul>
<li>We use Custom DPA Handler <a href="CustomDpaHandler-HTU21D-i2c.c">CustomDpaHandler-HTU21D-i2c.c</a> in this repo. Copy it into IQRF SDK folders and load to TR module as <a href="http://127.0.0.1:8000/SetupIqrfNetwork/#load-custom-dpa-handler">described here</a>.</li>
<li>Testing software:<ul>
<li>Tests user peripherial</li>
</ul>
</li>
</ul>
<h3 id="api-json-message">API JSON message</h3>
<p>We will use pure DPA messages handled via <a href="https://docs.iqrfsdk.org/iqrf-gateway-daemon/">Daemon JSON API</a>:</p>
<ul>
<li><a href="https://apidocs.iqrf.org/iqrf-gateway-daemon/json/#iqrf/iqrfRawHdp-request-1-0-0.json">RawHdp request  v1-0-0</a>, <a href="https://apidocs.iqrf.org/iqrf-gateway-daemon/json/iqrf/examples/iqrfRawHdp-request-1-0-0-example.json">..example</a></li>
<li><a href="https://apidocs.iqrf.org/iqrf-gateway-daemon/json/#iqrf/iqrfRawHdp-response-1-0-0.json">RawHdp response  v1-0-0</a>, <a href="https://apidocs.iqrf.org/iqrf-gateway-daemon/json/iqrf/examples/iqrfRawHdp-response-1-0-0-example.json">..example</a></li>
</ul>
<p><strong>DPA commands:</strong></p>
<table>
<thead>
<tr>
<th align="center">NADR</th>
<th align="center">PNUM</th>
<th align="center">PCMD</th>
<th align="center">HWPID</th>
<th align="center">PDATA</th>
<th>What</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">XXXX</td>
<td align="center">0x20</td>
<td align="center">00</td>
<td align="center">-</td>
<td align="center"></td>
<td>Get user periphery status</td>
</tr>
</tbody>
</table>
<ul>
<li><em>NADR: must be your address of IQRFBB-10 in IQRF network.</em></li>
<li><em>Numbers in table are in hex format.</em></li>
</ul>
<h3 id="testing-software">Testing Software</h3>
<p>The <a href="example-HTU21D.py">example-HTU21D.py</a> code:</p>
<pre><code class="py">#
# Copyright 2018 Logimic,s.r.o.
# www.logimic.com
#
# Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# Websockets example-ePir.py
import asyncio
import websockets
import json
import time

# This is IQRFBB-10 node address in IQRF network
boardAddr = 3

# JSON messages by &quot;https://docs.iqrfsdk.org/iqrf-gateway-daemon/api.html&quot;

GET_PERIPHERIAL = {
  &quot;mType&quot;: &quot;iqrfRawHdp&quot;,
  &quot;data&quot;: {
    &quot;msgId&quot;: &quot;testRawHdp&quot;,
    &quot;req&quot;: {
      &quot;nAdr&quot;: boardAddr,
      &quot;pNum&quot;: 0x20,
      &quot;pCmd&quot;: 0
    },
    &quot;returnVerbose&quot;: True
  }
}

async def hello():
    # Connect websockets
    async with websockets.connect(
            'ws://localhost:1338') as websocket:            

        count = 0
        while (count &lt; 50):
          print (f&quot;The count is:{count}&quot;)
          count = count + 1
          # Read all pins
          await websocket.send(json.dumps(GET_PERIPHERIAL))
          print(f&quot;Sent &gt; {GET_PERIPHERIAL}&quot;)        

          response = await websocket.recv()
          print(f&quot;Received &lt; {response}&quot;)      

        print(&quot;DONE....&quot;)

asyncio.get_event_loop().run_until_complete(hello())
</code></pre></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright 2018, All rights reserved, Logimic, s.r.o.</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>

<!--
MkDocs version : 1.0.4
Build Date UTC : 2019-01-05 09:56:03
-->
